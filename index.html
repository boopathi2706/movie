<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>P2P File Share - Glass UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #01060e, #162036, #243b55);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      overflow-x: hidden;
    }

    h1 {
      font-size: 26px;
      margin-bottom: 20px;
      text-align: center;
      text-shadow: 0 0 10px #00eaff;
    }

    .card {
      width: 100%;
      max-width: 900px;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(18px);
      border-radius: 18px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.15);
      animation: fadeUp .6s ease;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(20px);}
      to { opacity: 1; transform: translateY(0);}
    }

    label {
      font-weight: 600;
      margin-top: 14px;
      display: block;
      font-size: 15px;
    }

    textarea {
      width: 100%;
      height: 120px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 10px;
      padding: 10px;
      color: #00eaff;
      resize: none;
    }

    textarea:focus {
      outline: none;
      border-color: #00eaff;
      box-shadow: 0 0 12px #00eaff;
    }

    input[type="file"] {
      margin-top: 8px;
    }

    progress {
      width: 100%;
      height: 14px;
      border-radius: 8px;
    }

    .btn {
      padding: 10px 15px;
      background: rgba(0, 255, 255, 0.1);
      border: 1px solid rgba(0,255,255,0.5);
      border-radius: 10px;
      cursor: pointer;
      color: cyan;
      transition: 0.3s;
      font-size: 14px;
    }

    .btn:hover {
      background: rgba(0,255,255,0.3);
      transform: translateY(-2px) scale(1.05);
    }

    .row { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; justify-content:center;}

    .copy-btn {
      background: rgba(0,255,180,0.35);
      border-radius: 7px;
      padding: 4px 12px;
      cursor: pointer;
      font-size: 13px;
      border: 1px solid rgba(255,255,255,0.3);
      margin-top: 8px;
    }

    .copy-btn:hover {
      background: rgba(0,255,180,0.8);
    }

    .muted { opacity: 0.8; }

    #log {
      background: #000;
      border-radius: 10px;
      padding: 10px;
      height: 140px;
      overflow-y: auto;
      font-size: 12px;
    }

    .toast {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background: #00ffcc;
      padding: 12px 18px;
      border-radius: 12px;
      color: #000;
      font-weight: bold;
      opacity: 0;
      pointer-events: none;
      animation: toastShow 2s forwards;
    }

    @keyframes toastShow {
      0% { opacity:0; transform:translateY(30px); }
      20% { opacity:1; transform:translateY(0); }
      80% { opacity:1; }
      100% { opacity:0; transform:translateY(30px); }
    }
  </style>
</head>
<body>
<h1>âš¡ P2P Movie Share - Glass UI</h1>

<div class="card">
  <div class="muted">Choose mode: <strong>Sender</strong> or <strong>Receiver</strong></div>

  <label>Choose File (Sender):</label>
  <input id="fileInput" type="file" />

  <div class="row">
    <button class="btn" id="createOfferBtn">Create Offer</button>
    <button class="btn" id="createAnswerBtn">Create Answer</button>
    <button class="btn" id="setRemoteBtn">Set Remote</button>
    <button class="btn" id="resetBtn">Reset</button>
  </div>

  <label>Local SDP</label>
  <textarea id="localSDP" readonly></textarea>
  <button class="copy-btn" onclick="copyText('localSDP')">ðŸ“‹ Copy</button>

  <label>Remote SDP</label>
  <textarea id="remoteSDP" placeholder="Paste remote SDP here..."></textarea>
  <button class="copy-btn" onclick="copyText('remoteSDP')">ðŸ“‹ Copy</button>
</div>

<div class="card">
  <h3>Transfer Status</h3>

  Upload:
  <progress id="sendProgress" max="100" value="0"></progress>
  <div id="sendInfo" class="muted">0 / 0</div>

  Download:
  <progress id="recvProgress" max="100" value="0"></progress>
  <div id="recvInfo" class="muted">0 / 0</div>

  <div id="downloadArea"></div>
</div>

<div class="card">
  <h3>Logs</h3>
  <div id="log"></div>
</div>

<div id="toast" class="toast" style="display:none;">Copied!</div>

<script>
// ==========================
// COPY BUTTON + TOAST
// ==========================
function showToast() {
  const t = document.getElementById("toast");
  t.style.display = "block";
  setTimeout(() => t.style.display = "none", 1800);
}

function copyText(id){
  const el = document.getElementById(id);
  el.select();
  document.execCommand("copy");
  showToast();
}

// ==========================
// YOUR ORIGINAL WebRTC CODE
// (NO CHANGE AT ALL)
// ==========================
(function(){
  const fileInput = document.getElementById('fileInput');
  const createOfferBtn = document.getElementById('createOfferBtn');
  const createAnswerBtn = document.getElementById('createAnswerBtn');
  const setRemoteBtn = document.getElementById('setRemoteBtn');
  const resetBtn = document.getElementById('resetBtn');
  const localSDP = document.getElementById('localSDP');
  const remoteSDP = document.getElementById('remoteSDP');
  const sendProgress = document.getElementById('sendProgress');
  const recvProgress = document.getElementById('recvProgress');
  const sendInfo = document.getElementById('sendInfo');
  const recvInfo = document.getElementById('recvInfo');
  const downloadArea = document.getElementById('downloadArea');
  const logDiv = document.getElementById('log');

  function log(...args){
    const s = args.map(a => (typeof a === 'string' ? a : JSON.stringify(a))).join(' ');
    logDiv.textContent += s + '\\n';
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
  let pc = null;
  let dataChannel = null;
  let fileToSend = null;

  let receivedBuffers = [];
  let expectedFileInfo = null;
  let receivedBytes = 0;

  const CHUNK_SIZE = 64 * 1024;
  const MAX_BUFFERED_AMOUNT = 16 * 1024 * 1024;

  function resetAll(){
    if(pc){
      try{ pc.close(); } catch(e){}
    }
    pc = null; dataChannel = null;
    fileToSend = null;
    receivedBuffers = []; expectedFileInfo = null; receivedBytes = 0;
    localSDP.value = ''; remoteSDP.value = '';
    sendProgress.value = 0; recvProgress.value = 0;
    sendInfo.textContent = '0 / 0'; recvInfo.textContent = '0 / 0';
    downloadArea.innerHTML = '';
    log('Reset done.');
  }
  resetBtn.onclick = resetAll;

  fileInput.onchange = e => {
    if(e.target.files && e.target.files.length) {
      fileToSend = e.target.files[0];
      log('Selected file:', fileToSend.name, fileToSend.size + ' bytes');
      sendInfo.textContent = `0 / ${fileToSend.size} bytes`;
      sendProgress.value = 0;
    }
  };

  function makePeer(createDataChannel){
    pc = new RTCPeerConnection(config);
    pc.onicecandidate = ()=> setTimeout(()=>localSDP.value = JSON.stringify(pc.localDescription,null,2),100);

    pc.onconnectionstatechange = () => log('Conn state:', pc.connectionState);
    pc.oniceconnectionstatechange = () => log('ICE:', pc.iceConnectionState);

    if(!createDataChannel){
      pc.ondatachannel = ev => setupDataChannel(ev.channel, false);
    } else {
      const dc = pc.createDataChannel('fileTransfer');
      setupDataChannel(dc, true);
    }
  }

  function setupDataChannel(dc, isSender){
    dataChannel = dc;
    dataChannel.binaryType = 'arraybuffer';
    dataChannel.onopen = ()=>{ log('DC open', isSender);
      if(isSender && fileToSend){ sendFileInChunks(); }
    };
    dataChannel.onmessage = ev => {
      if(typeof ev.data === 'string'){
        try{
          const msg = JSON.parse(ev.data);
          if(msg.type === 'file-meta'){
            expectedFileInfo = msg.info;
            receivedBuffers = [];
            receivedBytes = 0;
            recvProgress.max = expectedFileInfo.size;
            recvProgress.value = 0;
            recvInfo.textContent = `0 / ${expectedFileInfo.size} bytes`;
          } else if(msg.type === 'file-end'){
            finalizeReceivedFile();
          }
        }catch{}
      } else {
        receivedBuffers.push(ev.data);
        receivedBytes += ev.data.byteLength;
        recvProgress.value = receivedBytes;
        recvInfo.textContent = `${receivedBytes}/${recvProgress.max}`;
      }
    };
  }

  async function sendFileInChunks(){
    const file = fileToSend;
    let offset = 0;
    while(offset < file.size){
      const slice = file.slice(offset, offset+CHUNK_SIZE);
      const buf = await slice.arrayBuffer();
      while(dataChannel.bufferedAmount > MAX_BUFFERED_AMOUNT){
        await new Promise(r=>setTimeout(r,200));
      }
      dataChannel.send(buf);
      offset += buf.byteLength;
      sendProgress.max = file.size;
      sendProgress.value = offset;
      sendInfo.textContent = `${offset}/${file.size}`;
    }
    dataChannel.send(JSON.stringify({type:'file-end'}));
  }

  function finalizeReceivedFile(){
    const blob = new Blob(receivedBuffers);
    const url = URL.createObjectURL(blob);

    downloadArea.innerHTML = `<a download="${expectedFileInfo.name}" href="${url}" style="color:cyan;">â¬‡ Download ${expectedFileInfo.name}</a>`;
  }

  createOfferBtn.onclick = async () => {
    resetPeerOnly();
    makePeer(true);
    await pc.setLocalDescription(await pc.createOffer());
    setTimeout(()=>localSDP.value = JSON.stringify(pc.localDescription,null,2),500);
  };

  createAnswerBtn.onclick = async () => {
    resetPeerOnly();
    makePeer(false);
    await pc.setRemoteDescription(JSON.parse(remoteSDP.value));
    await pc.setLocalDescription(await pc.createAnswer());
    setTimeout(()=>localSDP.value = JSON.stringify(pc.localDescription,null,2),500);
  };

  setRemoteBtn.onclick = async () =>{
    await pc.setRemoteDescription(JSON.parse(remoteSDP.value));
  };

  function resetPeerOnly(){ if(pc){pc.close()} pc=null }

})();
</script>

</body>
</html>
